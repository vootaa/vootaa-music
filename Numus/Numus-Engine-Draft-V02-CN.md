# Numus 引擎概念设计草案（非工程化） V0.2

定位：Numus 引擎是“确定性音乐素材织布机”（素材生产思想集合），而非重量级框架。  
目标：为 CarDJ-EDM 工作流提供可复现、可标注、可裁剪的音乐素材（音高序列 / 节奏形 / 能量包），再交由 Sonic Pi 骨干脚本组织。

---

## 1. 角色与边界

引擎负责：  

- 提供有限、清晰、可追溯的序列与模式（Pitch / Rhythm / Energy）。  
- 基于给定上下文（调性 / 能量 / 功能标签）派生“素材单元”集合。  
- 输出：MIDI（可渲染为 WAV）与对应 metadata。  

引擎不负责：  

- 混音 / 效果设计 / 动态处理  
- 响度与母带  
- 长时间自动结构编排（交给人工结构表）  
- 实时适配与复杂状态机  

---

## 2. 核心设计原则

1) 确定性：所有生成可被“源常数 + 偏移 + 映射规则”复原。  
2) 最小性：只保留生产“够用”素材的必要机制。  
3) 透明性：生成路径可读（不黑盒搜索）。  
4) 可删性：任意生成模块可以被手动替换/跳过，不破坏主流程。  

---

## 3. 抽象三层（概念）

- DNA（输入意图）：调性 / 基础和弦集合 / 节奏框架标签 / 能量曲线节点。  
- 生成层（纯函数思想）：序列片段提取 + 规则映射 → 素材单元。  
- 输出层：MIDI 片段 / WAV 渲染 / metadata（JSON）落地。  

---

## 4. 最小能力清单（MVP）

能力 | 说明 | 约束  
---- | ---- | ----  
Pitch 序列 | 从 π/φ 字符串切片映射到音阶索引 | 不做多层 Markov  
Rhythm 形 | 固定基础模式集合（4–8 个）+ 轻度变换（稀疏 / 倍速 / 反转） | 不合成复杂多重多米诺节奏  
Energy 包 | 输出 0–1 标准化能量曲线点（内插） | 不做机器学习拟合  
Variation 操作 | shift（平移）、thin（抽稀）、cluster（聚合）、accent（强化若干点） | 非随机  
Constraint 过滤 | 保证音域落入给定范围 / 节奏密度不超阈值 | 硬规则，拒绝则再取下段切片  
Metadata 记录 | 源常数标识 / 偏移 / 变换序列 / 过滤规则 | 必须写入  

---

## 5. 数据概念（无实现）

术语 | 含义  
---- | ----  
Cell | 最小素材单位：包含 (role, local_time, pitch/或为空, duration, tag)  
Pattern | 按功能聚合的 Cell 序列（如“上升扫描”）  
Frame | 与 Section 对齐的素材容器（内含多个 Pattern）  
Bundle | 一次批量生成的全部 Pattern 集合 + metadata  

---

## 6. 生成流程（概念管线）

输入：Section 上下文（调性 / 目标能量 / 频段约束 / 功能标签）  
→ 选择基准模式（节奏 or 音阶）  
→ 序列切片（π/φ索引区间）  
→ 映射（数值→音阶 or 密度→触发位置）  
→ 变换（shift / thin 等）  
→ 约束过滤（超出→换下一个切片）  
→ 标注角色（如 sparkle / lift_up / ambient_seed）  
→ 输出 Cells + metadata  
→ 可选渲染（MIDI→WAV）  

---

## 7. 确定性策略

项目内定义“数学源表”：

- π：字符序列（不修改，引用范围固定）
- φ：小数展开
- e：小数展开
- Fibonacci：预生前 N 项  
索引策略：  
- 每一 Section 指定：源名 + 起始 index + 长度  
- 变换链按顺序文字化记录（如：“thin(p=0.4) → shift(+2) → accent(beat=3)”）  
禁止：运行时随机跳转 / 动态漂移未记录偏移。  

---

## 8. 失败优先机制

若生成素材：

- 超出能量边界（例如在静态段落密度过高）  
- 与已有骨干冲突（频段重叠严重）  
- 在试听中“听不见”或“听过饱”  
→ 标记为丢弃，不存储；只保留最终被采用版本减少噪声。  

---

## 9. 与 CarDJ-EDM 的接口

输入（来自结构表）：  

- track_id / chapter_id / section_id  
- 调性（Key + Scale）  
- 时间窗口（起/止秒或小节）  
- 角色需求列表（如：['rise_noise', 'high_sparkle']）  
输出（文件 + JSON）：  
- wav_paths[]（可为空）  
- midi_paths[]（调试用）  
- metadata：每个素材源 → {source, offset, length, transforms, pitch_range, role}  

---

## 10. 简化与排除

暂不引入：  

- 图形化编辑  
- 模块热插拔系统  
- 复杂概率分布建模  
- 多目标优化 / AI 生成  
保留手动主导：骨干结构、素材是否采用、最终混合比例。  

---

## 11. 里程碑（可执行）

- 定义数学源常数文本文件  
- 选择 1 套节奏基准模式  
- 手工写第一个 Section 的素材需求表  
M1（首曲前 2 章完成）：  
- Pitch + Rhythm 切片 + 变换 + 输出 metadata  
- 3–5 个有效 WAV 采样被使用  
M2（首曲全曲）：  
- 全部 Section 生成素材 + 未用素材清理  
- 结构复盘：能量曲线 & 回调点确认  

---

## 12. 验收清单

- 是否每个已用 WAV 都有对应 metadata 记录？  
- 是否可以在不看音频逻辑文件的情况下复述其来源（源常数 + 偏移 + 变换）？  
- 是否未出现“引擎自动决定结构”现象？  
- 是否删除未采用的中间素材（防数据噪声膨胀）？  
- 是否单次变更只依赖文本配置改动而非重写代码？  

---

## 13. 下一步执行指引（Dawn Ignition 起步）

1) 为 Chapter 1 两个 Section 各写：角色需求（ambient_pad_sparkle / rise_noise）。  
2) 从 π 第 0–200 位分三段切片；映射到 C 大调高音区；抽稀到每 2–4 秒一次。  
3) 只渲染 1 组成功素材；试听后再考虑批量补充。  

---

结束：本引擎草案是“概念 & 操作约束”，不是实现说明。后续只在必要时追加“概念条目”，不添加代码段。
